<script>
  // ------------------- AI MODEL -------------------
  let classifier;
  let video;
  let flippedVideo;
  let label = "";
  let lastLabel = "";

  const modelURL = "https://teachablemachine.withgoogle.com/models/UdPBJ9EtfL/";

  function preload() {
    classifier = ml5.imageClassifier(modelURL + "model.json");
  }

  function setup() {
    const canvas = createCanvas(320, 260);
    canvas.parent("camera");
    video = createCapture(VIDEO);
    video.size(320, 240);
    video.hide();
    flippedVideo = ml5.flipImage(video);
    classifyVideo();

    // Fetch moisture data every 15 seconds
    setInterval(fetchThingSpeakData, 15000);
    fetchThingSpeakData();
  }

  function draw() {
    background(255);
    image(flippedVideo, 0, 0);
    fill(0);
    textSize(16);
    textAlign(CENTER);
    text(label, width / 2, height - 8);
  }

  function classifyVideo() {
    flippedVideo = ml5.flipImage(video);
    classifier.classify(flippedVideo, gotResult);
    flippedVideo.remove();
  }

  function gotResult(error, results) {
    if (error) {
      console.error(error);
      return;
    }
    label = results[0].label;
    document.getElementById("result").innerText = "Grain Type: " + label;

    // Send to ThingSpeak only if the result changes
    if (label !== lastLabel) {
      lastLabel = label;
      sendGrainToThingSpeak(label);
    }

    classifyVideo();
  }

  // ------------------- THINGSPEAK -------------------
  const channelID = "3138258";
  const readAPIKey = "R2C0VCC89AO4GGZY";
  const writeAPIKey = "K5XU7MZX3D1J5BDA"; // üîπ Replace this with your Write API key

  async function fetchThingSpeakData() {
    try {
      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=1`;
      const response = await fetch(url);
      const data = await response.json();
      const feed = data.feeds[0];

      const moisture = feed.field1;
      const status = feed.field2;

      let colorClass = "";
      if (status.toLowerCase().includes("good")) colorClass = "good";
      else if (status.toLowerCase().includes("average")) colorClass = "average";
      else colorClass = "bad";

      document.getElementById("moisture").innerHTML = `
        Moisture: <b>${moisture}%</b><br>
        Status: <b class="${colorClass}">${status}</b>
      `;
    } catch (err) {
      console.error(err);
      document.getElementById("moisture").innerText = "Error loading data.";
    }
  }

  async function sendGrainToThingSpeak(grainQuality) {
    try {
      const updateURL = `https://api.thingspeak.com/update?api_key=${writeAPIKey}&field3=${encodeURIComponent(grainQuality)}`;
      const response = await fetch(updateURL);
      if (response.ok) {
        console.log(`‚úÖ Uploaded: ${grainQuality}`);
        document.getElementById("result").innerHTML = `Grain Type: <b>${grainQuality}</b> ‚úîÔ∏è Sent`;
      } else {
        console.warn("ThingSpeak update failed.");
      }
    } catch (err) {
      console.error("Error sending to ThingSpeak:", err);
    }
  }
</script>
